<html>
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script src="http://underscorejs.org/underscore-min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="static/js/leap.js"></script>
</head>
<body>
    <input id="target" value="Vesta" /><button id="go">Go</button>
    <div id="map3d" style="height: 90%; width: 100%;"></div>
    <script>
    var results = {};
    function RemoveAllFeatures()
    {

        var root = window.ge.getLayerRoot();
        var folders = root.getElementsByType('KmlFolder').getLength();

        for (var id = 0; id < folders; id++) {
            // Get all the Folders in the root KML, and hide them
            // This disables the constellations, messier, etc.
            // Basically everything we don't care about
            root.getElementsByType('KmlFolder').item(id).setVisibility(false)
        }

        var features = ge.getFeatures();
        while (features.getLastChild() != null)
        {
        features.removeChild(features.getLastChild());
        }
    }
    $(document).ready(function () {
        $('#go').on('click', function (e) {
            e.preventDefault();

            var target = $('#target').val();
            var link = window.ge.createLink('');
            var href = 'http://' + window.location.host + '/api/kml/search?target=' + target;
            link.setHref(href);

            var networkLink = window.ge.createNetworkLink('');
            networkLink.set(link, true, true); // Sets the link, refreshVisibility, and flyToView

            RemoveAllFeatures()

            window.ge.getFeatures().appendChild(networkLink);
        });

        window.loadMaps = function () {
            google.load("earth", "1", {"callback": function () {
                    google.earth.createInstance('map3d', function (instance) {
                        window.ge = instance;
                        window.ge.getOptions().setMapType(ge.MAP_TYPE_SKY);
                        window.ge.getWindow().setVisibility(true);
                    }, function () {}, {});
            }});
        };

        window.loadMaps();

        // initialize LeapMotion
        var firstValidFrame = null;
        function map(value, inputMin, inputMax, outputMin, outputMax){
            outVal = ((value - inputMin) / (inputMax - inputMin) * (outputMax - outputMin) + outputMin);  
            if(outVal >  outputMax){
                outVal = outputMax;
            }
            if(outVal <  outputMin){
                outVal = outputMin;
            } 
            return outVal;
        }

        //request animation frame and connect to leap socket
        Leap.loop(function(frame) {
            if (frame.valid) {
                if (!firstValidFrame) firstValidFrame = frame
                var t = firstValidFrame.translation(frame)

                //limit y-axis between 0 and 180 degrees
                curY = map(t[1], -300, 300, 0, 179)

                //assign rotation coordinates
                rotateX = t[0]
                rotateY = -curY

                zoom = Math.max(0, t[2]);
                zoomFactor = 1/(1 + (zoom / 150));

                //console.log(rotateX, rotateY, zoom, zoomFactor);
                if (window.ge) {
                    var lookAt = window.ge.getView().copyAsLookAt(window.ge.ALTITUDE_RELATIVE_TO_GROUND);
                    lookAt.setLatitude(rotateX);
                    lookAt.setLatitude(rotateY);
                    ge.getView().setAbstractView(lookAt);
                }
            }
        }.bind(this));
    });
    </script>
</body>
</html>
